<div class="flex justify-between mt-5 mb-2">
  <app-search-bar class="mb-2 w-1/3" (searchStr)="sendSearchValue($event)"></app-search-bar>
  <ng-container *ngIf="moduleData | async as modData">
    <div class="cursor-pointer mt-5">
      <a *ngIf="currentUser.id == modData?.createdBy || currentUser?.role == 'admin'" [routerLink]="['/modules/add-module', moduleId]" class="px-6 py-3 rounded-md bg-[#F15B41] text-white no-underline hover:text-white text-base">+ Add module</a>
    </div>
  </ng-container>
</div>

<tui-loader [overlay]="true" size="xl" [showLoader]="fetchingTableData | async">
  <div class="relative overflow-x-auto rounded-lg shadow-lg">
    <table class="w-full text-sm text-left text-gray-500">
      <thead class="text-xs text-white uppercase bg-[#F15B41]">
        <tr>
          <ng-container *ngFor="let column of tableColumns; let i = index; let first = first; let last = last;">
            <th scope="col" class="px-6 py-3 text-sm">
              {{column}} &nbsp;
              <ng-container *ngIf="column === 'Status'; else notStatus">
              </ng-container>
              <ng-template #notStatus>
                <ng-container *ngIf="column === 'Title'">
                </ng-container>
                <ng-container *ngIf="column === 'Company Name'">
                </ng-container>
                <ng-container *ngIf="column === 'Module Code'">
                  <filter
                    [filterBy]="column"
                    [items]="filterMenuSubmodule"
                    (applyStatus)="sendFilters($event)"
                    (resetFilters)="resetFilterValues($event)"
                    [disabled]="tableData?.results?.length == 0"
                  >
                  </filter>
                </ng-container>
              </ng-template>
            </th>
          </ng-container>
          <th scope="col" class="py-3 text-sm text-center">
            Actions
          </th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngIf="tableData?.results?.length == 0; else showSubModules">
          <th colspan="12" role="row" class="px-5 py-10 text-lg text-center">
            It seems there is no data to show here!
          </th>
        </ng-container>

        <ng-template #showSubModules>
          <ng-container *ngFor="let data of tableData?.results; let i = index; let first = first; let last = last">
            <tr class="bg-white border-b border-gray-300">
              <td class="pl-6 py-4 flex gap-x-2 max-w-80">
                <img src="../../../assets/depa_logo.svg" alt="module_icon" width="45" height="45" class="rounded-lg">
                <p class="mt-3">{{data?.title}}</p>
              </td>
              <td class="px-6 py-4">
                {{data?.companyId?.title}}
              </td>
              <td class="px-6 py-4">
                {{data?.code}}
              </td>
              <td class="px-6 py-4">
                {{data?.status === 1 ? 'Published' : 'Rejected'}}
              </td>
              <td class="py-4 text-center">
                <div style="all: unset;" *ngIf="data?.status == 1">
                  <!-- here permissions cannot be set because workflow users cannot proceed if conditions are applied -->
                  <a title="Submissions" (click)="setSubmoduleSlug(data?.code, data?.id)" class="px-2 py-1 text-xs font-medium text-white no-underline bg-[#808285] rounded-md cursor-pointer mr-2 hover:text-white">
                    <i class="fa fa-eye fa-lg" aria-hidden="true"></i>
                  </a>
                </div>
                <a title="Edit" *ngIf="currentUser.id == data?.createdBy || currentUser?.role == 'admin'" [routerLink]="['/modules/edit-module', data?.id]" class="px-2 py-1 text-xs font-medium text-white no-underline bg-blue-400 rounded-md cursor-pointer hover:text-white">
                  <i class="fa fa-pencil fa-lg" aria-hidden="true"></i>
                </a>
                <a title="Delete" *ngIf="currentUser.id == data?.createdBy || currentUser?.role == 'admin'" (click)="showDialog(data?.id, template)" class="font-medium ml-2 px-2 py-1 bg-[#cf2729] text-white rounded-md hover:text-white no-underline cursor-pointer text-xs">
                  <i class="fa fa-trash-o fa-lg" aria-hidden="true"></i>
                </a>
                <!-- <a *ngIf="currentUser.id == data?.createdBy || currentUser?.role == 'admin'" [routerLink]="['/modules/submodule-details', data?.code]" class="px-2 py-1 ml-2 text-xs font-medium text-white no-underline bg-green-400 rounded-md cursor-pointer hover:text-white">
                  <i class="fa fa-eye fa-lg" aria-hidden="true"></i> View
                </a> -->
              </td>
            </tr>
          </ng-container>
        </ng-template>
      </tbody>
    </table>
    <div class="pt-10 pb-6">
      <tui-pagination
        [length]="tableData?.totalPages || 1"
        [index]="tableData?.page - 1 || 0"
        (indexChange)="goToPage($event)"
      ></tui-pagination>
    </div>
  </div>
</tui-loader>

<ng-template #template let-observer>
  <p class="pb-2 text-xl font-semibold text-center border-b border-gray-400">Delete Module</p>
  <p class="mt-4 text-base font-medium text-center">Are you sure you want to delete this submodule?</p>
  <div class="flex justify-center mt-4">
    <button
      tuiButton
      appearance="secondary-destructive"
      type="button"
      size="m"
      class="mx-3"
      (click)="deleteModule(); observer.complete()"
      >
      Confirm
    </button>

    <button
      tuiButton
      type="button"
      size="m"
      (click)="observer.complete()"
      >
      Cancel
    </button>
  </div>
</ng-template>
