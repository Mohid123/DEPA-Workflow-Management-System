<app-header></app-header>
<div class="bg_img_main">
  <section class="grid w-10/12 grid-cols-12 gap-4 mx-auto mt-48 pb-44">
    <div class="px-12 py-5 bg-white rounded-lg shadow-lg col-span-full">
      <p class="text-xl font-bold text-center">{{(isEditMode | async) == true ? 'Edit': 'Create'}} Category</p>
      <p class="text-xs text-center mt-2">Your modules will be listed against this category</p>
      <form>
        <form [formGroup]="moduleDetailsForm">
          <div class="my-3">
            <label class="block pb-1"
              >Category Title <span class="text-xs text-red-400">*</span></label
            >
            <input
              required
              [ngClass]="
                f['moduleTitle']?.invalid && f['moduleTitle']?.dirty
                  ? 'is-invalid'
                  : ''
              "
              formControlName="moduleTitle"
              class="form-control"
              type="text"
            />
            <ng-container
              [ngTemplateOutlet]="formError"
              [ngTemplateOutletContext]="{
                validation: 'required',
                message: 'Module Title is required',
                control: f['moduleTitle']
              }"
            ></ng-container>
          </div>
          <div class="my-7">
            <label class="block pb-1"
              >Category Code <span class="text-xs text-red-400">*</span></label
            >
            <input
              formControlName="moduleCode"
              class="form-control"
              type="text"
            />
          </div>
        </form>
        <p class="font-semibold text-lg inline-flex">
          <span>Default Module Workflow</span> &nbsp;
          <tui-tooltip
            [content]="worfklowHint"
            direction="right"
            class="mt-1"
          ></tui-tooltip>
        </p>
        <div [formGroup]="workflowForm">
          <ng-container formArrayName="workflows">
            <ng-container
              *ngFor="let workflow of workflows.controls; let i = index"
            >
              <p class="text-base font-semibold mt-7">
                Step {{ i === 0 ? "1" : i + 1 }}
              </p>
              <div class="grid grid-cols-12 gap-3 my-4" [formGroupName]="i">
                <div class="col-span-5">
                  <label class="block pb-1">Approvers
                    <span class="text-xs text-red-400">*</span>
                  </label>
                  <custom-multi-select
                    (checkUsersLength)="countUsers($event, i)"
                    formControlName="approverIds"
                    (approverList)="getApproverList($event, i)"
                  ></custom-multi-select>
                  <span class="text-xs text-red-500" *ngIf="(showError | async) && i === errorIndex">Please select either AND or OR as the condition</span>
                </div>
                <div class="col-span-5">
                  <label for="conditionSelect" class="block pb-1">
                    Condition
                    <span class="text-xs text-red-400">*</span>
                  </label>
                  <select
                    (change)="validateSelection(i)"
                    formControlName="condition"
                    class="h-10 form-select form-control"
                    aria-label="Default select example"
                    id="conditionSelect"
                  >
                    <option value="and">AND</option>
                    <option value="or">OR</option>
                    <option value="none">NONE</option>
                  </select>
                </div>
                <div class="col-span-1 mt-8 inline-flex">
                  <tui-tooltip
                    [content]="hint"
                    direction="right"
                    class="mr-4 mt-1 -ml-2"
                  ></tui-tooltip>
                  <tui-badged-content
                    [contentTop]="workflows.at(i).get('emailNotifyTo')?.value?.length"
                    [colorTop]="'green'"
                  >
                    <button
                      tuiIconButton
                      type="button"
                      size="s"
                      appearance="outline"
                      icon="tuiIconMailLarge"
                      (click)="openEmailNotifyModal(template, workflows, i)"
                    ></button>
                  </tui-badged-content>
                </div>
                <div class="col-span-1 mt-8 -ml-3">
                  <button
                    tuiIconButton
                    type="button"
                    size="s"
                    appearance="secondary-destructive"
                    icon="tuiIconTrash2Large"
                    (click)="removeWorkflowStep(i)"
                  ></button>
                </div>
              </div>
            </ng-container>
          </ng-container>
          <button
            tuiIconButton
            type="button"
            size="m"
            appearance="primary"
            icon="tuiIconPlusLarge"
            (click)="addWorkflowStep()"
          ></button>

          <div class="flex justify-end gap-x-3">
            <button
              tuiButton
              type="button"
              size="m"
              appearance="primary"
              (click)="nextStep()"
            >
              Publish
            </button>
            <button
              (click)="nextStep(3)"
              tuiButton
              type="button"
              size="m"
              appearance="secondary"
            >
              Save as Draft
            </button>
          </div>
        </div>
      </form>
    </div>
  </section>
</div>
<app-footer></app-footer>

<ng-template
  #formError
  let-control="control"
  let-message="message"
  let-validation="validation"
>
  <ng-container
    *ngIf="control.hasError(validation) && (control.dirty || control.touched)"
  >
    <div
      class="w-full mt-1 text-left fv-plugins-message-container text-xxs 2xl:text-xs"
    >
      <span
        class="text-red-400 fv-help-block text-xxs 2xl:text-xs 2xl:mb-2"
        role="alert"
      >
        {{ message }}
      </span>
    </div>
  </ng-container>
</ng-template>

<ng-template #template>
  <p class="text-lg font-semibold text-center">Email Notification Users</p>
  <p class="mt-3 text-base font-medium text-gray-500">
    Please specify the users you want to send the notification email to
  </p>
  <div class="flex flex-col justify-center my-5">
    <tui-input-tag
      [formControl]="
        currentFieldArray?.controls[activeEmailIndex]?.controls['emailNotifyTo']
      "
      class="b-form"
      [tuiTextfieldLabelOutside]="true"
      (searchChange)="onSearchChange($event)"
    >
      Type to search and press Enter to select...
      <tui-data-list-wrapper
        *tuiDataList
        [items]="userListForEmail"
      ></tui-data-list-wrapper>
    </tui-input-tag>
  </div>
  <div class="flex justify-start gap-x-3">
    <button tuiButton type="button" size="m" (click)="validateEmails()">
      Confirm & Close
    </button>
    <button appearance="accent" tuiButton type="button" size="m" (click)="cancelEmailNotify()">
      Remove Users & Close
    </button>
  </div>
</ng-template>

<ng-template #hint>
  <strong class="text-base">How conditions work?</strong>
  <hr>
  <ul class="mt-2">
    <li><strong>AND</strong> implies that every user of the step must provide approval</li>
    <li class="my-2"><strong>OR</strong> implies that any one of the users may provide approval</li>
    <li><strong>NONE</strong> implies that there is only one user per step and hence no conditon is necessary</li>
  </ul>
</ng-template>


<ng-template #worfklowHint>
  <p class="text-center">
    <strong class="text-base">Default Workflow</strong>
  </p>
  <hr>
  <p class="mt-2">Default workflow will be attached to every new module that is created. Users have the option to change
     the default workflow when creating a new module.
  </p>
</ng-template>
