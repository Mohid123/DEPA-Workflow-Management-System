<app-header></app-header>
<section class="w-11/12 h-auto min-h-screen mx-auto mt-52 pb-44">
  <section>
    <h3 class="text-xl font-semibold">Edit app</h3>
  </section>
  <form class="block pt-5" [formGroup]="subModuleForm">
    <!--Title-->
    <div class="mt-3 mb-5">
      <label class="block pb-1">App Title <span class="text-xs text-red-400">*</span></label>
        <input required
          [ngClass]="
            f['title']?.invalid && f['title']?.dirty
              ? 'is-invalid'
              : ''
          "
          formControlName="title"
          class="form-control"
          type="text"
        />
        <ng-container
          [ngTemplateOutlet]="formError"
          [ngTemplateOutletContext]="{
            validation: 'required',
            message: 'App Title is required',
            control: f['title']
          }"
        ></ng-container>
    </div>

    <!--Description-->
    <div class="mt-3 mb-5">
      <label class="block pb-1">App Description<span class="text-xs text-red-400">*</span></label>
        <textarea
          required
          [ngClass]="
            f['description']?.invalid &&
            f['description']?.dirty
              ? 'is-invalid'
              : ''
          "
          formControlName="description"
          class="form-control"
          type="text"
          rows="4"
        ></textarea>
        <ng-container
          [ngTemplateOutlet]="formError"
          [ngTemplateOutletContext]="{
            validation: 'required',
            message: 'A Description is required',
            control: f['description']
          }"
        ></ng-container>
    </div>

    <!--Image-->
    <div class="my-5">
      <label class="block pb-1">App Icon<span class="text-xs text-red-400">*</span></label>
      <label
        (change)="onFileSelect($event)"
        for="dropzone-file"
        class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-bray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600"
        >
          <tui-loader
            [inheritColor]="true"
            [size]="'l'"
            [showLoader]="false"
            [overlay]="true"
          >
            <div *ngIf="file" class="flex justify-center">
              <img
                [src]="base64File"
                alt="app_icon"
                width="200"
                height="200"
                class="rounded-md"
              />
            </div>
            <div *ngIf="!file" class="flex justify-start">
              <div class="mx-8">
                <img
                  src="../../../../../assets/windows.svg"
                  width="32"
                  height="32"
                />
              </div>
              <div class="flex flex-col">
                <p class="mb-3 text-lg font-semibold text-black">
                  App Icon
                </p>
                <ul class="text-sm text-gray-400 list-disc">
                  <li>Icon should be 1:1 ratio</li>
                  <li>Only (JPEG, PNG, WEBP) extensions are allowed</li>
                  <li>Up to 2MB file size is allowed</li>
                </ul>
              </div>
            </div>
          </tui-loader>
          <input id="dropzone-file" type="file" class="hidden" />
      </label>
    </div>

    <div class="my-7">
      <label class="block pb-1">Company Name <span class="text-xs text-red-400">*</span></label>
      <select required [ngClass]="f['companyId']?.invalid && f['companyId']?.dirty ? 'is-invalid' : ''" formControlName="companyId" class="form-control" type="text">
        <ng-container *ngFor="let company of companyList;">
          <option [value]="company?.value">{{company?.label}}</option>
        </ng-container>
      </select>
      <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
        validation: 'required',
        message: 'Company is required',
        control: f['companyId']
      }"></ng-container>
    </div>

    <div class="my-7">
      <label class="block pb-1">Category Name <span class="text-xs text-red-400">*</span></label>
      <select required [ngClass]="f['categoryId']?.invalid && f['categoryId']?.dirty ? 'is-invalid' : ''" formControlName="categoryId" class="form-control" type="text">
        <ng-container *ngFor="let category of categoryList;">
          <option [value]="category?.value">{{category?.label}}</option>
        </ng-container>
      </select>
      <ng-container [ngTemplateOutlet]="formError" [ngTemplateOutletContext]="{
        validation: 'required',
        message: 'Category is required',
        control: f['categoryId']
      }"></ng-container>
    </div>

    <!--Admin and View only users-->
    <div class="grid grid-cols-12 gap-3 my-8">
      <div class="col-span-6">
        <label class="block pb-1 text-sm">Admin users <sup>(optional)</sup></label>
        <custom-multi-select
          formControlName="adminUsers"
          (approverList)="setAdminUsers($event)"
        ></custom-multi-select>
      </div>

      <div class="col-span-6">
        <label class="block pb-1 text-sm">View Only users <sup>(optional)</sup></label>
        <custom-multi-select
          formControlName="viewOnlyUsers"
          (approverList)="setViewUsers($event)"
        ></custom-multi-select>
      </div>
    </div>

    <!--Form preview-->
    <div class="mb-5 mt-7">
      <h3 class="mb-5 text-lg font-semibold">Edit Form/s</h3>
      <h4 class="text-base font-semibold text-center">Form/s Preview</h4>
      <div class="flex flex-col w-full px-5 mx-auto mt-5 border border-gray-400 border-dashed rounded-md bg-gray-50">
        <ng-container *ngIf="formComponents[0]?.components?.length > 0">
          <section class="flex justify-between my-8">
            <nav
              tuiTabs
              vertical="left"
              class="w-32 mr-5"
            >
              <ng-container *ngFor="let tab of formTabs; let j = index">
                <button (click)="activeIndex = j" tuiTab>{{tab}}</button>
              </ng-container>
            </nav>
            <ng-container *ngFor="let form of formComponents; let i = index;">
              <div *ngIf="activeIndex == i" class="w-full well jsonviewer">
                <div class="flex justify-end gap-x-2">
                  <a (click)="sendFormForEdit(i, form?.id)" class="px-2 py-1 rounded-md cursor-pointer bg-slate-200">
                    <i class="fa fa-pencil-square fa-2x text-slate-500 hover:text-slate-600" aria-hidden="true"></i>
                  </a>
                  <a (click)="deleteForm(form?.id)" class="px-2 py-1 bg-red-100 rounded-md cursor-pointer">
                    <i class="text-red-500 fa fa-trash fa-2x hover:text-red-600" aria-hidden="true"></i>
                  </a>
                </div>
                <formio [language]="language" [options]="options" [form]="form"></formio>
              </div>
            </ng-container>

          </section>
        </ng-container>
        <ng-container *ngIf="formComponents[0]?.components?.length == 0">
          <div class="grid grid-cols-12 gap-2">
            <div data-placeholder class="h-8 col-span-6 my-3 overflow-hidden bg-gray-200 rounded-md"></div>
            <div data-placeholder class="h-8 col-span-6 my-3 overflow-hidden bg-gray-200 rounded-md"></div>
            <div data-placeholder class="h-32 col-span-12 mb-3 overflow-hidden bg-gray-200 rounded-md"></div>
          </div>
        </ng-container>
      </div>
      <div class="w-full mx-auto my-1">
        <p class="text-xs text-gray-500">The form you add will appear here</p>
      </div>
    </div>

    <!--Add new Form-->
    <div class="mt-7">
      <a (click)="saveDraft()" class="px-5 py-3 rounded-lg bg-[#a58f81] no-underline text-white cursor-pointer hover:text-white">
        {{formComponents[0]?.components?.length == 0 ? 'Add form' : 'Add another'}}
      </a>
    </div>

    <!--Edit Workflow-->
    <div class="mt-12">
      <h4 class="text-lg font-semibold">Edit workflow</h4>
      <ng-container formArrayName="workFlowId">
        <ng-container *ngFor="let workflow of workflows.controls; let i = index; let first = first; let last = last">
          <p class="text-base font-semibold mt-7">Step {{i === 0 ? '1' : i+1}}</p>
          <div class="grid grid-cols-12 gap-3 my-4" [formGroupName]="i">
            <ng-container *ngIf="i == 0">
              <div class="col-span-3">
                <label class="block pb-1">Approvers <span class="text-xs text-red-400">*</span></label>
                <custom-multi-select (checkUsersLength)="countUsers($event, i)" formControlName="approverIds" (approverList)="getApproverList($event, i)"></custom-multi-select>
                <span class="text-xs text-red-500" *ngIf="(showError | async) && i === errorIndex">Please select either AND or OR as the condition</span>
              </div>
              <div class="col-span-3">
                <label for="conditionSelect" class="block pb-1">Condition <span class="text-xs text-red-400">*</span></label>
                <select (change)="validateSelection(i)" formControlName="condition" class="h-10 mt-2 form-select form-control" aria-label="Default select example" id="conditionSelect">
                  <option value="and">AND</option>
                  <option value="or">OR</option>
                  <option value="none">NONE</option>
                </select>
              </div>
              <div class="col-span-1 mt-8 inline-flex">
                <tui-tooltip
                  [content]="hint"
                  direction="right"
                  class="mr-4 mt-1 -ml-2"
                ></tui-tooltip>
                <tui-badged-content
                  [contentTop]="
                    workflows.at(i).get('emailNotifyTo')?.value?.length
                  "
                  [colorTop]="'green'"
                >
                  <button
                    tuiIconButton
                    type="button"
                    size="s"
                    appearance="outline"
                    icon="tuiIconMailLarge"
                    (click)="openEmailNotifyModal(template, workflows, i)"
                  ></button>
                </tui-badged-content>
              </div>
              <div class="col-span-4">
                <div class="flex justify-between mt-8">
                  <tui-radio-labeled
                    [formControl]="accessTypeValue"
                    class="tui-space_bottom-3"
                    [item]="items[0]"
                  >
                    <div>Any (Create)</div>
                    <div class="text-xxs font-extralight">Users can create a new submission</div>
                  </tui-radio-labeled>

                  <tui-radio-labeled
                    [formControl]="accessTypeValue"
                    class="tui-space_bottom-3"
                    [item]="items[1]"
                  >
                    <div>Any (Create & Modify)</div>
                    <div class="text-xxs font-extralight">Users can create a new submission and modify it's workflow</div>
                  </tui-radio-labeled>
                </div>
              </div>
              <div class="col-span-1 mt-8">
                <button
                  tuiIconButton
                  type="button"
                  size="s"
                  appearance="secondary-destructive"
                  icon="tuiIconTrash2Large"
                  (click)="removeWorkflowStep(i)"
                ></button>
              </div>
            </ng-container>
            <ng-container *ngIf="i > 0">
              <div class="col-span-4">
                <label class="block pb-1">Approvers <span class="text-xs text-red-400">*</span></label>
                <custom-multi-select (checkUsersLength)="countUsers($event, i)" formControlName="approverIds" (approverList)="getApproverList($event, i)"></custom-multi-select>
                <span class="text-xs text-red-500" *ngIf="(showError | async) && i === errorIndex">Please select either AND or OR as the condition</span>
              </div>
              <div class="col-span-4">
                <label for="conditionSelect" class="block pb-1">Condition <span class="text-xs text-red-400">*</span></label>
                <select (change)="validateSelection(i)" formControlName="condition" class="h-10 mt-2 form-select form-control" aria-label="Default select example" id="conditionSelect">
                  <option value="and">AND</option>
                  <option value="or">OR</option>
                  <option value="none">NONE</option>
                </select>
              </div>
              <div class="col-span-1 mt-8 inline-flex">
                <tui-tooltip
                  [content]="hint"
                  direction="right"
                  class="mr-4 mt-1 -ml-2"
                ></tui-tooltip>
                <tui-badged-content
                  [contentTop]="
                    workflows.at(i).get('emailNotifyTo')?.value?.length
                  "
                  [colorTop]="'green'"
                >
                  <button
                    tuiIconButton
                    type="button"
                    size="s"
                    appearance="outline"
                    icon="tuiIconMailLarge"
                    (click)="openEmailNotifyModal(template, workflows, i)"
                  ></button>
                </tui-badged-content>
              </div>
              <div class="col-span-1 mt-8 -ml-4">
                <button
                  tuiIconButton
                  type="button"
                  size="s"
                  appearance="secondary-destructive"
                  icon="tuiIconTrash2Large"
                  (click)="removeWorkflowStep(i)"
                ></button>
              </div>
            </ng-container>
          </div>
        </ng-container>
      </ng-container>
      <button
        tuiIconButton
        type="button"
        size="m"
        appearance="primary"
        icon="tuiIconPlusLarge"
        (click)="addWorkflowStep()"
      ></button>
    </div>

    <div class="flex justify-center gap-2 mt-10">
      <button
        tuiButton
        type="button"
        size="m"
        appearance="primary"
        (click)="saveSubModule()"
        [showLoader]="(isCreatingSubModule | async) == true"
      >
        Publish
      </button>
      <button
        tuiButton
        type="button"
        size="m"
        appearance="secondary"
        (click)="saveSubModule(3)"
        [showLoader]="(isCreatingSubModule | async) == true"
      >
        Save as Draft
      </button>
      <button
        tuiButton
        type="button"
        size="m"
        appearance="accent"
        (click)="cancelSubmodule()"
      >Cancel</button>
    </div>
  </form>
</section>
<app-footer></app-footer>

<ng-template #formError let-control="control" let-message="message" let-validation="validation">
  <ng-container *ngIf="control.hasError(validation) && (control.dirty || control.touched)">
    <div class="w-full mt-1 text-left fv-plugins-message-container text-xxs 2xl:text-xs">
      <span class="text-red-400 fv-help-block text-xxs 2xl:text-xs 2xl:mb-2" role="alert">
        {{ message }}
      </span>
    </div>
  </ng-container>
</ng-template>

<!--Email Notify Modal-->
<ng-template #template>
  <p class="text-lg font-semibold text-center">Email Notification Users</p>
  <p class="mt-3 text-base font-medium text-gray-500">
    Please specify the users you want to send the notification email to
  </p>
  <div class="flex flex-col justify-center my-5">
    <tui-input-tag
      [formControl]="
        currentFieldArray?.controls[activeEmailIndex]?.controls['emailNotifyTo']
      "
      class="b-form"
      [tuiTextfieldLabelOutside]="true"
      (searchChange)="onSearchChange($event)"
    >
      Type to search and press Enter to select...
      <tui-data-list-wrapper
        *tuiDataList
        [items]="userListForEmail"
      ></tui-data-list-wrapper>
    </tui-input-tag>
  </div>
  <div class="flex justify-start gap-x-3">
    <button tuiButton type="button" size="m" (click)="validateEmails()">
      Confirm & Close
    </button>
    <button appearance="accent" tuiButton type="button" size="m" (click)="cancelEmailNotify()">
      Remove Users & Close
    </button>
  </div>
</ng-template>

<ng-template #hint>
  <strong class="text-base">How conditions work?</strong>
  <hr>
  <ul class="mt-2">
    <li><strong>AND</strong> implies that every user of the step must provide approval</li>
    <li class="my-2"><strong>OR</strong> implies that any one of the users may provide approval</li>
    <li><strong>NONE</strong> implies that there is only one user per step and hence no conditon is necessary</li>
  </ul>
</ng-template>